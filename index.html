<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>activerecord-postgres-hstore by engageis</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>activerecord-postgres-hstore</h1>
        <p>Goodbye serialize, hello hstore. Speed up hashes in the database.</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/engageis/activerecord-postgres-hstore" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/engageis/activerecord-postgres-hstore/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/engageis/activerecord-postgres-hstore/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>Goodbye serialize, hello hstore. <a href="http://travis-ci.org/softa/activerecord-postgres-hstore"><img src="https://secure.travis-ci.org/softa/activerecord-postgres-hstore.png?branch=master" alt="Build Status"></a>
</h1>

<p>You need dynamic columns in your tables. What do you do?</p>

<ul>
<li>Create lots of tables to handle it. Nice, now you’ll need more models and lots of additional sqls. Insertion and selection will be slow as hell.</li>
<li>Use a noSQL database just for this issue. Good luck.</li>
<li>Create a serialized column. Nice, insertion will be fine, and reading data from a record too. But, what if you have a condition in your select that includes serialized data? Yeah, regular expressions.</li>
</ul><h2>Note about 0.7</h2>

<p>I have decided to clean up the old code and provide only a custom serializer in this new version.</p>

<p>In order to acomplish this I had to drop support for older versions of Rails (3.0 and earlier) and also
remove some monkey patches that added functionality to the Hash, String, and some ActiveRecord objects.
This monkey patches provided methods such as Hash#to_hstore and String#from_hstore.</p>

<p><strong>If you rely on this feature please stick to 0.6 version</strong> and there is still a branch named 0.6 to which you can submit your pull requests.</p>

<h2>Requirements</h2>

<p>Postgresql 8.4+ with contrib and Rails 3.1+ (If you want to try on older rails versions I recommend the 0.6 and ealier versions of this gem)
On Ubuntu, this is easy: <code>sudo apt-get install postgresql-contrib-9.1</code></p>

<p>On Mac you have a couple of options:</p>

<ul>
<li><a href="http://www.enterprisedb.com/products-services-training/pgdownload#osx">the binary package kindly provided by EnterpriseDB</a></li>
<li>
<a href="https://github.com/mxcl/homebrew">Homebrew’s</a> Postgres installation also includes the contrib packages: <code>brew install postgres</code>
</li>
<li><a href="http://postgresapp.com/">Postgres.app</a></li>
</ul><h2>Install</h2>

<p>Hstore is a PostgreSQL contrib type, <a href="http://www.postgresql.org/docs/9.2/static/hstore.html">check it out first</a>.</p>

<p>Then, just add this to your Gemfile:</p>

<p><code>gem 'activerecord-postgres-hstore'</code></p>

<p>And run your bundler:</p>

<p><code>bundle install</code></p>

<p>Now you need to create a migration that adds hstore support for your
PostgreSQL database:</p>

<p><code>rails g hstore:setup</code></p>

<p>Run it:</p>

<p><code>rake db:migrate</code></p>

<p>Finally you can create your own tables using hstore type. It’s easy:</p>

<pre><code>rails g model Person name:string data:hstore
rake db:migrate
</code></pre>

<p>You’re done.
Well, not yet. Don’t forget to add indexes. Like this:</p>

<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">people_gist_data</span> <span class="k">ON</span> <span class="n">people</span> <span class="k">USING</span> <span class="n">GIST</span><span class="p">(</span><span class="k">data</span><span class="p">);</span>
</pre></div>

<p>or</p>

<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">people_gin_data</span> <span class="k">ON</span> <span class="n">people</span> <span class="k">USING</span> <span class="n">GIN</span><span class="p">(</span><span class="k">data</span><span class="p">);</span>
</pre></div>

<p>This gem provides some functions to generate this kind of index inside your migrations.
For the model Person we could create an index (defaults to type GIST) over the data field with this migration:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">AddIndexToPeople</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_hstore_index</span> <span class="ss">:people</span><span class="p">,</span> <span class="ss">:data</span>
  <span class="k">end</span> 
<span class="k">end</span>
</pre></div>

<p>To understand the difference between the two types of indexes take a
look at <a href="http://www.postgresql.org/docs/9.2/static/textsearch-indexes.html">PostgreSQL docs</a>.</p>

<h2>Usage</h2>

<p>This gem only provides a custom serialization coder.
If you want to use it just put in your Gemfile:</p>

<pre><code>gem 'activerecord-postgres-hstore'
</code></pre>

<p>Now add a line (for each hstore column) on the model you have your hstore columns.
Assuming a model called <strong>Person</strong>, with a <strong>data</strong> field on it, the
code should look like:</p>

<div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">serialize</span> <span class="ss">:data</span><span class="p">,</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Coders</span><span class="o">::</span><span class="no">Hstore</span>
<span class="k">end</span>
</pre></div>

<p>This way, you will automatically start with an empty hash that you can write attributes to.</p>

<pre><code>irb(main):001:0&gt; person = Person.new
=&gt; #&lt;Person id: nil, name: nil, data: {}, created_at: nil, updated_at: nil&gt;
irb(main):002:0&gt; person.data['favorite_color'] = 'blue'
=&gt; "blue"
</code></pre>

<h3>Querying the database</h3>

<p>Now you just need to learn a little bit of new
sqls for selecting stuff (creating and updating is transparent).
Find records that contains a key named 'foo’:</p>

<pre><code>Person.where("data ? 'foo'")
</code></pre>

<p>Find records where 'foo’ is equal to 'bar’:</p>

<pre><code>Person.where("data -&gt; 'foo' = 'bar'")
</code></pre>

<p>This same sql is at least twice as fast (using indexes) if you do it
that way:</p>

<pre><code>Person.where("data @&gt; 'foo=&gt;bar'")
</code></pre>

<p>Find records where 'foo’ is not equal to 'bar’:</p>

<pre><code>Person.where("data -&gt; 'foo' &lt;&gt; 'bar'")
</code></pre>

<p>Find records where 'foo’ is like 'bar’:</p>

<pre><code>Person.where("data -&gt; 'foo' LIKE '%bar%'")
</code></pre>

<p>If you need to delete a key in a record, you can do it that way:</p>

<pre><code>person.destroy_key(:data, :foo)
</code></pre>

<p>This way you’ll also save the record:</p>

<pre><code>person.destroy_key!(:data, :foo)
</code></pre>

<p>The destroy_key method returns 'self’, so you can chain it:</p>

<pre><code>person.destroy_key(:data, :foo).destroy_key(:data, :bar).save
</code></pre>

<p>But there is a shortcuts for that:</p>

<p>person.destroy_keys(:data, :foo, :bar)</p>

<p>And finally, if you need to delete keys in many rows, you can:</p>

<pre><code>Person.delete_key(:data, :foo)
</code></pre>

<p>and with many keys:</p>

<pre><code>Person.delete_keys(:data, :foo, :bar)
</code></pre>

<h2>Caveats</h2>

<p>hstore keys and values have to be strings. This means <code>true</code> will become <code>"true"</code> and <code>42</code> will become <code>"42"</code> after you save the record. Only <code>nil</code> values are preserved.</p>

<p>It is also confusing when querying:</p>

<pre><code>Person.where("data -&gt; 'foo' = :value", value: true).to_sql
#=&gt; SELECT "people".* FROM "people" WHERE ("data -&gt; 'foo' = 't'") # notice 't'
</code></pre>

<p>To avoid the above, make sure all named parameters are strings:</p>

<pre><code>Person.where("data -&gt; 'foo' = :value", value: some_var.to_s)
</code></pre>

<p>Have fun.</p>

<h2>Test Database</h2>

<p>To have hstore enabled when you load your database schema (as happens in rake db:test:prepare), you
have two options.</p>

<p>The first option is creating a template database with hstore installed and set the template option
in database.yml to that database.</p>

<p>The second option is to uncomment or add the following line in config/application.rb</p>

<pre><code>config.active_record.schema_format = :sql
</code></pre>

<p>This will change your schema dumps from Ruby to SQL. If you're
unsure about the implications of this change, we suggest reading this
<a href="http://guides.rubyonrails.org/migrations.html#schema-dumping-and-you">Rails Guide</a>.</p>

<h2>Help</h2>

<p>You can use issues in github for that. Or else you can reach us at
twitter: <a href="https://twitter.com/#!/dbiazus">@dbiazus</a> or <a href="https://twitter.com/#!/joaomilho">@joaomilho</a></p>

<h2>Note on Patches/Pull Requests</h2>

<ul>
<li>Fork the project.</li>
<li>Make your feature addition or bug fix.</li>
<li>Add tests for it. This is important so I don’t break it in a future version unintentionally.</li>
<li>Commit, do not mess with rakefile, version, or history.  (if you want to have your own version, that is fine but bump version in a commit by itself I can ignore when I pull)</li>
<li>Send me a pull request. Bonus points for topic branches.</li>
</ul><h2>Copyright</h2>

<p>Copyright © 2010 Juan Maiz. See LICENSE for details.</p>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/engageis">engageis</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>